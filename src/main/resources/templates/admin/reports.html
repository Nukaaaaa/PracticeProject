<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–û—Ç—á—ë—Ç—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .card-title {
            font-weight: 600;
        }
        .btn-back {
            margin-top: 20px;
        }
        .container {
            max-width: 900px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold">–û—Ç—á—ë—Ç—ã —Å–∏—Å—Ç–µ–º—ã</h1>
        <p class="text-muted">–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–∞—Ö –∏ –ø—Ä–æ–µ–∫—Ç–∞—Ö</p>
    </div>

    <!-- –í—Å–µ–≥–æ –∑–∞–¥–∞—á -->
    <div class="card p-4 mb-5 text-center">
        <h5 class="card-title">–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –≤ —Å–∏—Å—Ç–µ–º–µ</h5>
        <p class="card-text fs-3 text-primary" th:text="${totalTasks}">0</p>
    </div>

    <hr class="my-5">

    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
    <div class="text-center mb-4">
        <h2 class="fw-bold">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
        <p class="text-muted">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–æ–ª—è—Ö –∏ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö</p>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="card p-4">
                <h5 class="card-title">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
                <p class="card-text fs-4 text-primary" th:text="${totalUsers}">0</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-4">
                <h5 class="card-title">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</h5>
                <p class="card-text fs-4 text-danger" th:text="${adminCount}">0</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-4">
                <h5 class="card-title">–û–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
                <p class="card-text fs-4 text-success" th:text="${userCount}">0</p>
            </div>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
    <div class="mb-5">
        <h5 class="fw-bold mb-3">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h5>
        <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between align-items-center"
                th:each="user : ${recentUsers}">
                <span th:text="${user.name}">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                <span class="badge bg-secondary" th:text="${user.role}">USER</span>
            </li>
        </ul>
    </div>

    <hr class="my-5">

    <!-- üìä –ü—Ä–æ–µ–∫—Ç—ã -->
    <div class="text-center mb-4">
        <h2 class="fw-bold">–ü—Ä–æ–µ–∫—Ç—ã</h2>
        <p class="text-muted">–°–º–æ—Ç—Ä–∏—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º –ø—Ä–æ–µ–∫—Ç–∞</p>
    </div>

    <div class="list-group">
        <div th:each="project : ${projects}"
             class="list-group-item d-flex justify-content-between align-items-center">
            <span th:text="${project.name}">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</span>
            <button class="btn btn-outline-info"
                    data-bs-toggle="modal"
                    data-bs-target="#projectReportModal"
                    th:attr="data-project-id=${project.id}">
                üìä –û—Ç—á—ë—Ç
            </button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ -->
    <div class="modal fade" id="projectReportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–û—Ç—á—ë—Ç –ø–æ –ø—Ä–æ–µ–∫—Ç—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="projectReportContent">
                    <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è –æ—Ç—á—ë—Ç–∞</p>
                </div>
            </div>
        </div>
    </div>

    <!-- üìå –§—Ä–∞–≥–º–µ–Ω—Ç –æ—Ç—á—ë—Ç–∞ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º -->
    <div th:fragment="projectReport">
        <div th:if="${columnStats != null}">
            <h5 class="fw-bold mb-3">–û—Ç—á—ë—Ç –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º</h5>

            <p><strong>–í—Å–µ–≥–æ –∑–∞–¥–∞—á:</strong> <span th:text="${totalTasks}">0</span></p>

            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>–ö–æ–ª–æ–Ω–∫–∞</th>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="entry : ${columnStats}">
                    <td th:text="${entry.key}">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏</td>
                    <td th:text="${entry.value}">0</td>
                </tr>
                </tbody>
            </table>

            <div class="row">
                <div class="col-md-6">
                    <canvas id="columnBarChart"></canvas>
                </div>
                <div class="col-md-6">
                    <canvas id="columnPieChart"></canvas>
                </div>
            </div>

            <script th:inline="javascript">
                const labels = [[${#lists.newArrayList(columnStats.keySet())}]];
                const data = [[${#lists.newArrayList(columnStats.values())}]];

                new Chart(document.getElementById('columnBarChart'), {
                    type: 'bar',
                    data: { labels: labels, datasets: [{ label: '–ó–∞–¥–∞—á–∏', data: data, backgroundColor: '#0d6efd' }] }
                });

                new Chart(document.getElementById('columnPieChart'), {
                    type: 'pie',
                    data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#0d6efd','#198754','#ffc107','#dc3545'] }] }
                });
            </script>
        </div>

        <div th:if="${columnStats == null}">
            <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç.</p>
        </div>
    </div>

    <div class="text-center btn-back">
        <a href="/admin/dashboard" class="btn btn-outline-primary">
            ‚Üê –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
        </a>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById('projectReportModal');
        modal.addEventListener('show.bs.modal', function (event) {
            const projectId = event.relatedTarget.getAttribute('data-project-id');
            const content = document.getElementById("projectReportContent");
            content.innerHTML = "<p class='text-info'>–ó–∞–≥—Ä—É–∑–∫–∞...</p>";

            fetch(`/reports/project/${projectId}`)
                .then(res => res.text())
                .then(html => content.innerHTML = html)
                .catch(() => content.innerHTML = "<p class='text-danger'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á—ë—Ç–∞</p>");
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
